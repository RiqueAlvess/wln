{% extends "base.html" %}

{% block title %}Análise do Setor: {{ setor.nome }} - {{ branding.nome_app }}{% endblock %}

{% block extra_head %}
<style>
    .analysis-header {
        background: linear-gradient(135deg, {{ branding.cor_primaria }} 0%, {{ branding.cor_secundaria }} 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    .score-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .score-badge {
        font-size: 2rem;
        font-weight: bold;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        display: inline-block;
    }
    .score-badge.critico {
        background-color: #dc3545;
        color: white;
    }
    .score-badge.importante {
        background-color: #ffc107;
        color: #333;
    }
    .score-badge.moderado {
        background-color: #17a2b8;
        color: white;
    }
    .score-badge.aceitavel {
        background-color: #28a745;
        color: white;
    }
    .dimension-bar {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        margin-top: 0.5rem;
        overflow: hidden;
    }
    .dimension-fill {
        height: 100%;
        transition: width 0.3s ease;
    }
    .recommendation-card {
        border-left: 4px solid {{ branding.cor_primaria }};
        padding-left: 1rem;
        margin-bottom: 1rem;
    }
    .alert-card {
        border-left: 4px solid #dc3545;
        background-color: #fff5f5;
    }
    .loading-spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1400px;">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url('analytics:dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url('analytics:sector_analysis_list') }}">Análises de Setores</a></li>
            <li class="breadcrumb-item active">{{ setor.nome }}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="analysis-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-robot"></i> Análise do Setor: {{ setor.nome }}
                </h1>
                <p class="mb-0">
                    <i class="bi bi-calendar3"></i> Campanha: {{ campaign.nome }}
                    <span class="ms-3"><i class="bi bi-building"></i> {{ setor.unidade.empresa.nome }}</span>
                </p>
            </div>
            <div>
                {% if analysis %}
                <button class="btn btn-light" onclick="regenerateAnalysis()">
                    <i class="bi bi-arrow-clockwise"></i> Regenerar Análise
                </button>
                <a href="#" class="btn btn-light ms-2">
                    <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                </a>
                {% else %}
                <button class="btn btn-light" onclick="generateAnalysis()">
                    <i class="bi bi-magic"></i> Gerar Análise
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    {% if not analysis %}
    <!-- Sem análise -->
    <div class="alert alert-info">
        <h4><i class="bi bi-info-circle"></i> Nenhuma análise disponível</h4>
        <p>Clique em "Gerar Análise" para criar uma análise inteligente deste setor usando IA.</p>
    </div>
    {% elif analysis.status == 'processing' %}
    <!-- Processando -->
    <div class="alert alert-warning">
        <div class="d-flex align-items-center">
            <div class="loading-spinner me-3"></div>
            <div>
                <h4 class="mb-0">Processando análise...</h4>
                <p class="mb-0">Aguarde enquanto a IA analisa os dados do setor.</p>
            </div>
        </div>
    </div>
    {% elif analysis.status == 'failed' %}
    <!-- Erro -->
    <div class="alert alert-danger">
        <h4><i class="bi bi-exclamation-triangle"></i> Erro ao gerar análise</h4>
        <p>{{ analysis.error_message }}</p>
        <button class="btn btn-danger" onclick="regenerateAnalysis()">
            <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
        </button>
    </div>
    {% else %}
    <!-- Análise completa -->
    <div class="row">
        <!-- Coluna principal -->
        <div class="col-lg-8">
            <!-- Diagnóstico -->
            <div class="score-card">
                <h3><i class="bi bi-clipboard2-pulse"></i> Diagnóstico Geral</h3>
                <hr>
                <p class="lead">{{ analysis.diagnostico }}</p>
            </div>

            <!-- Fatores Contribuintes -->
            {% if analysis.fatores_contribuintes %}
            <div class="score-card">
                <h3><i class="bi bi-list-check"></i> Fatores Contribuintes</h3>
                <hr>
                <ul class="list-group list-group-flush">
                    {% for fator in analysis.fatores_contribuintes %}
                    <li class="list-group-item">
                        <i class="bi bi-arrow-right-circle text-primary"></i> {{ fator }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Pontos de Atenção -->
            {% if analysis.pontos_atencao %}
            <div class="score-card">
                <h3><i class="bi bi-exclamation-triangle text-warning"></i> Pontos de Atenção</h3>
                <hr>
                {% for ponto in analysis.pontos_atencao %}
                <div class="alert alert-warning">
                    <h5>
                        <i class="bi bi-flag-fill"></i> {{ ponto.dimensao }}
                        <span class="badge bg-{% if ponto.nivel == 'Crítico' %}danger{% elif ponto.nivel == 'Importante' %}warning{% else %}info{% endif %}">
                            {{ ponto.nivel }}
                        </span>
                    </h5>
                    <p class="mb-0">{{ ponto.descricao }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Recomendações -->
            {% if analysis.recomendacoes %}
            <div class="score-card">
                <h3><i class="bi bi-lightbulb"></i> Recomendações</h3>
                <hr>
                {% for rec in analysis.recomendacoes|sort(attribute='prioridade') %}
                <div class="recommendation-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="mb-0">
                            <span class="badge bg-primary">Prioridade {{ rec.prioridade }}</span>
                            {{ rec.acao }}
                        </h5>
                    </div>
                    <p class="text-muted mb-1">
                        <i class="bi bi-clock"></i> <strong>Prazo:</strong> {{ rec.prazo }}
                    </p>
                    <p class="text-muted mb-1">
                        <i class="bi bi-person"></i> <strong>Responsável sugerido:</strong> {{ rec.responsavel_sugerido }}
                    </p>
                    <p class="text-muted mb-0">
                        <i class="bi bi-box"></i> <strong>Recursos:</strong> {{ rec.recursos }}
                    </p>
                    <a href="#" class="btn btn-sm btn-outline-primary mt-2" onclick="createActionPlan({{ rec.prioridade }})">
                        <i class="bi bi-plus-circle"></i> Criar Plano de Ação
                    </a>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Impacto Esperado -->
            {% if analysis.impacto_esperado %}
            <div class="score-card bg-light">
                <h3><i class="bi bi-graph-up-arrow text-success"></i> Impacto Esperado</h3>
                <hr>
                <p class="mb-0">{{ analysis.impacto_esperado }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Scores -->
            <div class="score-card">
                <h4><i class="bi bi-bar-chart"></i> Scores por Dimensão</h4>
                <hr>
                {% for dimensao, data in analysis.scores.items() %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>{{ dimensao.replace('_', ' ').title() }}</span>
                        <strong>{{ "%.2f"|format(data.score) }}</strong>
                    </div>
                    <div class="dimension-bar">
                        <div class="dimension-fill bg-{% if data.interpretacao == 'Crítico' %}danger{% elif data.interpretacao == 'Importante' %}warning{% elif data.interpretacao == 'Moderado' %}info{% else %}success{% endif %}"
                             style="width: {{ (data.score / 5 * 100)|int }}%"></div>
                    </div>
                    <small class="text-muted">{{ data.classificacao }}</small>
                </div>
                {% endfor %}
            </div>

            <!-- Pontos Fortes -->
            {% if analysis.pontos_fortes %}
            <div class="score-card bg-success-subtle">
                <h4><i class="bi bi-trophy text-success"></i> Pontos Fortes</h4>
                <hr>
                {% for ponto in analysis.pontos_fortes %}
                <div class="mb-2">
                    <h6 class="text-success">{{ ponto.dimensao }}</h6>
                    <p class="small mb-0">{{ ponto.descricao }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Alertas de Sentimento -->
            {% if analysis.alertas_sentimento %}
            <div class="score-card alert-card">
                <h4><i class="bi bi-shield-exclamation text-danger"></i> Alertas de Sentimento</h4>
                <hr>
                {% for alerta in analysis.alertas_sentimento %}
                <div class="alert alert-{% if alerta.gravidade == 'Alta' %}danger{% elif alerta.gravidade == 'Média' %}warning{% else %}info{% endif %} p-2 mb-2">
                    <h6>
                        <span class="badge bg-dark">{{ alerta.tipo }}</span>
                        <span class="badge bg-{% if alerta.gravidade == 'Alta' %}danger{% elif alerta.gravidade == 'Média' %}warning{% else %}info{% endif %}">
                            {{ alerta.gravidade }}
                        </span>
                    </h6>
                    <p class="small mb-1"><em>"{{ alerta.evidencia }}"</em></p>
                    <p class="small mb-0"><strong>Ação:</strong> {{ alerta.recomendacao_imediata }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Metadados -->
            <div class="score-card">
                <h5><i class="bi bi-info-circle"></i> Informações</h5>
                <hr>
                <p class="small mb-1">
                    <strong>Total de Respostas:</strong> {{ analysis.total_respostas }}
                </p>
                <p class="small mb-1">
                    <strong>Gerado por:</strong> {{ analysis.generated_by }}
                </p>
                <p class="small mb-0">
                    <strong>Data:</strong> {{ analysis.created_at.strftime('%d/%m/%Y %H:%M') }}
                </p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function generateAnalysis() {
    if (!confirm('Deseja gerar uma análise inteligente deste setor usando IA?')) {
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gerando...';

    fetch('{{ url("analytics:generate_sector_analysis") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            setor_id: '{{ setor.id }}',
            campaign_id: '{{ campaign.id }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Erro: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-magic"></i> Gerar Análise';
        }
    })
    .catch(error => {
        alert('Erro ao gerar análise: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic"></i> Gerar Análise';
    });
}

function regenerateAnalysis() {
    if (!confirm('Deseja regenerar a análise? A análise atual será substituída.')) {
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Regenerando...';

    fetch('{{ url("analytics:generate_sector_analysis") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            setor_id: '{{ setor.id }}',
            campaign_id: '{{ campaign.id }}',
            force_regenerate: 'true'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Erro: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Regenerar Análise';
        }
    })
    .catch(error => {
        alert('Erro ao regenerar análise: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Regenerar Análise';
    });
}

function createActionPlan(prioridade) {
    alert('Funcionalidade de criação de plano de ação será implementada em breve.');
    // TODO: Integrar com sistema de planos de ação
}
</script>
{% endblock %}
