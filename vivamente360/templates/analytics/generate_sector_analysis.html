{% extends "base.html" %}

{% block title %}Gerar Análise de Setor - {{ branding.nome_app }}{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1400px;">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url('analytics:dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url('analytics:sector_analysis_list') }}">Análises de Setores</a></li>
            <li class="breadcrumb-item active">Gerar Análise</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-4">
        <h1><i class="bi bi-robot"></i> Gerar Análise de Setor com IA</h1>
        <p class="text-muted">Selecione um setor para gerar uma análise detalhada com Inteligência Artificial</p>
    </div>

    <!-- Campaign Info -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-calendar-check"></i> Campanha Selecionada</h5>
            <p class="card-text mb-0"><strong>{{ campaign.nome }}</strong></p>
            <p class="text-muted small mb-0">{{ campaign.total_convidados | default(0) }} convidados • {{ campaign.total_respostas | default(0) }} respostas</p>
        </div>
    </div>

    <!-- Sector Selection -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-building"></i> Selecione o Setor</h5>
        </div>
        <div class="card-body">
            {% if setores %}
            <div class="row">
                {% for setor in setores %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 sector-card" style="cursor: pointer;" onclick="selectSector({{ setor.id }}, '{{ setor.nome }}')">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-building"></i> {{ setor.nome }}
                            </h6>
                            <p class="text-muted small mb-1">
                                <i class="bi bi-geo-alt"></i> {{ setor.unidade.nome }}
                            </p>
                            {% set respostas_count = setor.surveyresponse_set.filter(campaign=campaign).count() %}
                            <p class="text-muted small mb-0">
                                <i class="bi bi-people"></i> {{ respostas_count }} resposta{{ 's' if respostas_count != 1 else '' }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle"></i> Nenhum setor disponível</h5>
                <p class="mb-0">Não há setores com respostas nesta campanha. Por favor, selecione outra campanha ou aguarde respostas.</p>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<!-- Include Modal de Status de Exportação -->
{% include 'components/export_status_modal.html' %}

<style>
.sector-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.sector-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-color: var(--bs-primary);
}
</style>

<script src="{{ static('js/export_handler.js') }}"></script>
<script>
function selectSector(sectorId, sectorName) {
    // Make request to enqueue analysis
    fetch('{{ url("analytics:generate_sector_analysis") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'setor_id': sectorId,
            'campaign_id': {{ campaign.id }},
            'force_regenerate': 'false'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'queued' && data.task_id) {
            // Usar modal de status customizado com redirecionamento
            if (window.ExportStatusManager) {
                window.ExportStatusManager.show(data.task_id, `Gerando análise com IA para ${sectorName}...`);

                // Adicionar listener customizado para redirecionar quando concluído
                const originalShowSuccess = window.ExportStatusManager.showSuccess;
                window.ExportStatusManager.showSuccess = function(taskData) {
                    // Verificar se tem redirect_url no payload da task
                    if (taskData.payload && taskData.payload.redirect_url) {
                        window.location.href = taskData.payload.redirect_url;
                    } else {
                        // Redirecionar para lista de análises
                        window.location.href = '{{ url("analytics:sector_analysis_list") }}';
                    }
                };
            } else {
                alert(data.message || 'Análise enfileirada com sucesso!');
            }
        } else if (data.status === 'success' && data.redirect_url) {
            // Analysis already exists
            window.location.href = data.redirect_url;
        } else {
            if (window.showErrorModal) {
                window.showErrorModal('Erro', data.message || 'Erro ao processar análise');
            } else {
                alert('Erro ao processar: ' + (data.message || 'Erro desconhecido'));
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (window.showErrorModal) {
            window.showErrorModal('Erro', 'Erro ao gerar análise. Por favor, tente novamente.');
        } else {
            alert('Erro ao gerar análise. Por favor, tente novamente.');
        }
    });
}
</script>
{% endblock %}
