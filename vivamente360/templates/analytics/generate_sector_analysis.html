{% extends "base.html" %}

{% block title %}Gerar Análise de Setor - {{ branding.nome_app }}{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1400px;">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url('analytics:dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url('analytics:sector_analysis_list') }}">Análises de Setores</a></li>
            <li class="breadcrumb-item active">Gerar Análise</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-4">
        <h1><i class="bi bi-robot"></i> Gerar Análise de Setor com IA</h1>
        <p class="text-muted">Selecione um setor para gerar uma análise detalhada com Inteligência Artificial</p>
    </div>

    <!-- Campaign Info -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-calendar-check"></i> Campanha Selecionada</h5>
            <p class="card-text mb-0"><strong>{{ campaign.nome }}</strong></p>
            <p class="text-muted small mb-0">{{ campaign.total_convidados | default(0) }} convidados • {{ campaign.total_respostas | default(0) }} respostas</p>
        </div>
    </div>

    <!-- Sector Selection -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-building"></i> Selecione o Setor</h5>
        </div>
        <div class="card-body">
            {% if setores %}
            <div class="row">
                {% for setor in setores %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 sector-card" style="cursor: pointer;" onclick="selectSector({{ setor.id }}, '{{ setor.nome }}')">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-building"></i> {{ setor.nome }}
                            </h6>
                            <p class="text-muted small mb-1">
                                <i class="bi bi-geo-alt"></i> {{ setor.unidade.nome }}
                            </p>
                            {% set respostas_count = setor.surveyresponse_set.filter(campaign=campaign).count() %}
                            <p class="text-muted small mb-0">
                                <i class="bi bi-people"></i> {{ respostas_count }} resposta{{ 's' if respostas_count != 1 else '' }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle"></i> Nenhum setor disponível</h5>
                <p class="mb-0">Não há setores com respostas nesta campanha. Por favor, selecione outra campanha ou aguarde respostas.</p>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<style>
.sector-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.sector-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-color: var(--bs-primary);
}
</style>

<script>
// Função auxiliar para obter CSRF token
function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.content;
    const input = document.querySelector('[name="csrfmiddlewaretoken"]');
    return input ? input.value : '{{ csrf_token }}';
}

// Função para mostrar toast
function showToast(message, type = 'info', duration = 3000) {
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
    }

    const bgClass = {
        'success': 'bg-success',
        'error': 'bg-danger',
        'info': 'bg-info'
    }[type] || 'bg-info';

    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: duration });
    toast.show();

    toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
}

// Função para gerar análise de setor
function selectSector(sectorId, sectorName) {
    // Fazer requisição para enfileirar análise
    fetch('{{ url("analytics:generate_sector_analysis") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCsrfToken()
        },
        body: new URLSearchParams({
            'setor_id': sectorId,
            'campaign_id': {{ campaign.id }},
            'force_regenerate': 'false'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erro ao iniciar análise');
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'queued' && data.task_id) {
            // Mostrar toast de sucesso
            showToast(
                `✓ Análise de IA iniciada para <strong>${sectorName}</strong>!<br>` +
                `<small>Você receberá uma notificação quando estiver pronta (pode levar alguns minutos).</small>`,
                'success',
                6000
            );

            // Redirecionar para lista de análises após 3 segundos
            setTimeout(() => {
                window.location.href = '{{ url("analytics:sector_analysis_list") }}';
            }, 3000);
        } else if (data.status === 'success' && data.redirect_url) {
            // Análise já existe - redirecionar imediatamente
            showToast('✓ Análise já existe! Redirecionando...', 'info', 2000);
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 2000);
        } else {
            // Erro genérico
            throw new Error(data.message || 'Erro ao processar análise');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast(
            `✗ Erro ao gerar análise: ${error.message}<br>` +
            `<small>Por favor, tente novamente.</small>`,
            'error',
            5000
        );
    });
}
</script>
{% endblock %}
