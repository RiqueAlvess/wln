<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ branding.nome_app }}{% endblock %}</title>
    {% if branding.favicon_url %}
    <link rel="icon" href="{{ branding.favicon_url }}">
    {% endif %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom CSS - Paleta Corporativa Moderna -->
    <link href="{{ static('css/custom.css') }}" rel="stylesheet">
    <style>
        :root {
            --bs-primary: {{ branding.cor_primaria }};
            --bs-primary-rgb: {{ branding.cor_primaria|replace('#', '')|int(base=16) // 65536 }}, {{ (branding.cor_primaria|replace('#', '')|int(base=16) // 256) % 256 }}, {{ branding.cor_primaria|replace('#', '')|int(base=16) % 256 }};
            --cor-fonte-primaria: {{ branding.cor_fonte }};
        }

        /* Cores principais */
        .bg-primary {
            background-color: {{ branding.cor_primaria }} !important;
            color: {{ branding.cor_fonte }} !important;
        }

        .text-primary {
            color: {{ branding.cor_primaria }} !important;
        }

        /* Botões */
        .btn-primary {
            background-color: {{ branding.cor_primaria }};
            border-color: {{ branding.cor_primaria }};
            color: {{ branding.cor_fonte }} !important;
            transition: all 0.3s ease;
        }

        .btn-primary:hover,
        .btn-primary:focus,
        .btn-primary:active {
            background-color: {{ branding.cor_secundaria }} !important;
            border-color: {{ branding.cor_secundaria }} !important;
            color: {{ branding.cor_fonte }} !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-outline-primary {
            color: {{ branding.cor_primaria }};
            border-color: {{ branding.cor_primaria }};
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover,
        .btn-outline-primary:focus,
        .btn-outline-primary:active {
            background-color: {{ branding.cor_primaria }} !important;
            border-color: {{ branding.cor_primaria }} !important;
            color: {{ branding.cor_fonte }} !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Links */
        a {
            color: {{ branding.cor_primaria }};
            text-decoration: none;
            transition: color 0.2s ease;
        }

        a:hover {
            color: {{ branding.cor_secundaria }};
        }

        /* Estilos de branding dinâmico sobrescrevem custom.css quando necessário */
        .navbar-brand-custom {
            color: {{ branding.cor_fonte }} !important;
        }

        .navbar-brand-custom:hover {
            color: {{ branding.cor_fonte }} !important;
            opacity: 0.95;
        }

    </style>
    {% block extra_head %}{% endblock %}
</head>
<body>
    {% if request.user.is_authenticated %}
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid px-4" style="max-width: 1400px; margin: 0 auto;">
            <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url('analytics:dashboard') }}">
                {% if branding.logo_url %}
                <img src="{{ branding.logo_url }}" alt="Logo" height="36" class="rounded">
                {% else %}
                <i class="bi bi-shield-check fs-4 text-primary"></i>
                {% endif %}
                <div class="d-flex flex-column">
                    <span class="fw-bold">{{ branding.nome_app }}</span>
                    <span class="text-muted" style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em;">Risk Management System</span>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto ms-4">
                    {# Dashboard - acessível para RH e Liderança #}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url('analytics:dashboard') }}">
                            <i class="bi bi-bar-chart-line-fill"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>

                    {# Recursos exclusivos para RH e Superusuário (Liderança vê APENAS Dashboard) #}
                    {% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url('analytics:campaign_comparison') }}">
                            <i class="bi bi-graph-up-arrow"></i>
                            <span>Comparação</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url('surveys:list') }}">
                            <i class="bi bi-folder-fill"></i>
                            <span>Campanhas</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url('articles:list') }}">
                            <i class="bi bi-newspaper"></i>
                            <span>Artigos</span>
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {# Link para tela de processamento #}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url('core:task_processing') }}" title="Processamento de Arquivos">
                            <i class="bi bi-list-task"></i>
                            <span class="d-none d-lg-inline">Processamento</span>
                        </a>
                    </li>

                    {# Notificações #}
                    <li class="nav-item dropdown">
                        <a class="nav-link position-relative" href="#" id="notificationsDropdown"
                           data-bs-toggle="dropdown" aria-expanded="false" title="Notificações">
                            <i class="bi bi-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                  id="notification-badge" style="display: none; font-size: 0.65rem;">
                                0
                            </span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end" style="width: 350px; max-height: 400px; overflow-y: auto;"
                             id="notifications-dropdown">
                            <div class="dropdown-header d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Notificações</span>
                                <button class="btn btn-sm btn-link text-decoration-none p-0"
                                        onclick="markAllNotificationsRead()" style="font-size: 0.75rem;">
                                    Marcar todas como lidas
                                </button>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div id="notifications-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-center small" href="{{ url('core:task_processing') }}">
                                Ver todas as tarefas
                            </a>
                        </div>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            <span>{{ request.user.username }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url('accounts:logout') }}">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span>Sair</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {% endif %}

    <main class="container-fluid py-4">
        {% if get_messages(request) %}
        {% for message in get_messages(request) %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    {# Incluir modal de erro genérico em todas as páginas #}
    {% include 'components/error_modal.html' %}

    {# Modal de Status de Exportação #}
    {% include 'components/export_status_modal.html' %}

    {# Sistema de Notificações #}
    {% if request.user.is_authenticated %}
    <script src="{{ static('js/export_handler.js') }}"></script>
    <script>
        let notificationCheckInterval = null;

        // Carregar contador de notificações
        async function loadNotificationCount() {
            try {
                const response = await fetch('/api/notifications/unread_count/');
                const data = await response.json();

                const badge = document.getElementById('notification-badge');
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao carregar contador de notificações:', error);
            }
        }

        // Carregar lista de notificações
        async function loadNotifications() {
            const container = document.getElementById('notifications-list');

            try {
                const response = await fetch('/api/notifications/?page_size=10&ordering=-created_at');
                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-3"><small>Nenhuma notificação</small></div>';
                    return;
                }

                let html = '';
                data.results.forEach(notif => {
                    html += renderNotification(notif);
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
                container.innerHTML = '<div class="text-center text-danger py-3"><small>Erro ao carregar</small></div>';
            }
        }

        // Renderizar notificação
        function renderNotification(notif) {
            const isUnread = !notif.is_read;
            const bgClass = isUnread ? 'bg-light' : '';
            const opacityStyle = isUnread ? '' : 'opacity: 0.6;';

            const icons = {
                'task_completed': 'check-circle text-success',
                'task_failed': 'x-circle text-danger',
                'file_ready': 'file-earmark-arrow-down text-primary',
                'info': 'info-circle text-info',
                'warning': 'exclamation-triangle text-warning',
                'error': 'x-octagon text-danger'
            };

            const icon = icons[notif.notification_type] || 'bell';

            let actionButton = '';
            if (notif.link_url) {
                actionButton = `<a href="${notif.link_url}" class="btn btn-sm btn-outline-primary mt-2">${notif.link_text || 'Ver'}</a>`;
            }

            return `
                <div class="dropdown-item ${bgClass}" style="white-space: normal; ${opacityStyle}"
                     onclick="markNotificationRead(${notif.id}, '${notif.link_url || ''}')">
                    <div class="d-flex align-items-start gap-2">
                        <i class="bi bi-${icon} mt-1"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold small">${notif.title}</div>
                            <div class="small text-muted">${notif.message}</div>
                            <div class="small text-muted mt-1">${notif.time_ago}</div>
                            ${actionButton}
                        </div>
                        ${isUnread ? '<span class="badge bg-primary">Nova</span>' : '<span class="badge bg-secondary">Lida</span>'}
                    </div>
                </div>
            `;
        }

        // Marcar notificação como lida
        async function markNotificationRead(id, linkUrl) {
            try {
                await fetch(`/api/notifications/${id}/mark_read/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                loadNotificationCount();
                loadNotifications();

                if (linkUrl) {
                    window.location.href = linkUrl;
                }
            } catch (error) {
                console.error('Erro ao marcar notificação como lida:', error);
            }
        }

        // Marcar todas como lidas
        async function markAllNotificationsRead() {
            try {
                const response = await fetch('/api/notifications/mark_all_read/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao marcar notificações');
                }

                const data = await response.json();

                // Atualizar UI
                loadNotificationCount();
                loadNotifications();

                // Feedback visual com toast
                if (window.showToast) {
                    showToast(
                        '<i class="bi bi-check-circle-fill"></i> <strong>Notificações marcadas como lidas</strong><br>' + data.message,
                        'success',
                        3000
                    );
                }
            } catch (error) {
                console.error('Erro ao marcar todas como lidas:', error);
                if (window.showToast) {
                    showToast(
                        '<i class="bi bi-x-circle"></i> <strong>Erro ao marcar notificações</strong><br>Por favor, tente novamente.',
                        'error',
                        4000
                    );
                } else {
                    alert('Erro ao marcar notificações como lidas. Por favor, tente novamente.');
                }
            }
        }

        // Função auxiliar para obter cookie CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Carregar notificações quando dropdown abre
        document.getElementById('notificationsDropdown').addEventListener('click', function() {
            loadNotifications();
        });

        // Iniciar verificação periódica
        document.addEventListener('DOMContentLoaded', function() {
            loadNotificationCount();

            // Atualizar contador a cada 30 segundos
            notificationCheckInterval = setInterval(loadNotificationCount, 30000);
        });

        // Limpar intervalo ao sair da página
        window.addEventListener('beforeunload', function() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
            }
        });
    </script>
    {% endif %}

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999;" id="toastContainer"></div>

    <!-- Toast System Script -->
    <script>
        /**
         * Sistema de Toast Global
         * Exibe notificações toast rápidas e não-bloqueantes
         * @param {string} message - Mensagem a ser exibida (aceita HTML)
         * @param {string} type - Tipo do toast: 'success', 'error', 'warning', 'info'
         * @param {number} duration - Duração em ms (padrão: 5000)
         */
        // Fila para prevenir toasts duplicados
        window.toastQueue = window.toastQueue || new Set();

        window.showToast = function(message, type = 'info', duration = 5000) {
            // Verificar se já existe toast com mesma mensagem e tipo
            const toastKey = `${message}-${type}`;
            if (window.toastQueue.has(toastKey)) {
                console.log('Toast duplicado bloqueado:', message);
                return;
            }

            const container = document.getElementById('toastContainer');
            if (!container) {
                console.error('Toast container not found');
                return;
            }

            // Adicionar à fila para prevenir duplicatas
            window.toastQueue.add(toastKey);

            // Remover da fila após a duração + buffer
            setTimeout(() => window.toastQueue.delete(toastKey), duration + 100);

            const toastId = 'toast-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            const bgClasses = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            };
            const bgClass = bgClasses[type] || 'bg-info';

            const icons = {
                'success': '<i class="bi bi-check-circle-fill me-2"></i>',
                'error': '<i class="bi bi-exclamation-triangle-fill me-2"></i>',
                'warning': '<i class="bi bi-exclamation-circle-fill me-2"></i>',
                'info': '<i class="bi bi-info-circle-fill me-2"></i>'
            };
            const icon = icons[type] || '';

            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${icon}${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', toastHtml);

            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement, {
                delay: duration,
                autohide: true
            });

            bsToast.show();

            // Remove do DOM após fechar
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        };

        /**
         * Atalho para toast de sucesso
         */
        window.showSuccess = function(message, duration = 5000) {
            showToast(message, 'success', duration);
        };

        /**
         * Atalho para toast de erro
         */
        window.showError = function(message, duration = 5000) {
            showToast(message, 'error', duration);
        };

        /**
         * Atalho para toast de aviso
         */
        window.showWarning = function(message, duration = 5000) {
            showToast(message, 'warning', duration);
        };

        /**
         * Atalho para toast de informação
         */
        window.showInfo = function(message, duration = 5000) {
            showToast(message, 'info', duration);
        };
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
