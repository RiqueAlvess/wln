{% extends 'base.html' %}

{% block title %}Dashboard de Riscos Psicossociais{% endblock %}

{% block extra_head %}
<style>
    /* Estilos espec√≠ficos do dashboard */
    .chart-container {
        position: relative;
        height: 400px;
    }

    .badge-vermelho {
        background-color: #dc3545;
        font-weight: 600;
        padding: 0.4em 0.75em;
        border-radius: 0.375rem;
    }
    .badge-laranja {
        background-color: #fd7e14;
        font-weight: 600;
        padding: 0.4em 0.75em;
        border-radius: 0.375rem;
    }
    .badge-amarelo {
        background-color: #ffc107;
        color: #000;
        font-weight: 700;
        padding: 0.4em 0.75em;
        border-radius: 0.375rem;
    }
    .badge-verde {
        background-color: #28a745;
        font-weight: 600;
        padding: 0.4em 0.75em;
        border-radius: 0.375rem;
    }

    .section-title {
        border-left: 5px solid var(--primary-blue);
        padding-left: 1rem;
        margin: 2.5rem 0 1.5rem 0;
        font-weight: 800;
        letter-spacing: -0.02em;
        position: relative;
    }

    .section-title::before {
        content: '';
        position: absolute;
        left: -5px;
        top: 50%;
        transform: translateY(-50%);
        width: 5px;
        height: 40%;
        background: var(--secondary-blue);
        border-radius: 0 4px 4px 0;
    }

    /* Melhorias nos cards de filtros */
    .card-header {
        background: linear-gradient(135deg, var(--bg-white) 0%, var(--bg-light-gray) 100%);
        font-weight: 700;
        border-bottom: 2px solid var(--border-light);
    }

    /* Top setores cr√≠ticos */
    .list-group-item {
        transition: var(--transition-base);
        border-left: 3px solid transparent;
    }

    .list-group-item:hover {
        border-left-color: var(--primary-blue);
        background-color: rgba(15, 102, 189, 0.03);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-end mb-4 pb-3" style="border-bottom: 2px solid var(--border-light);">
    <div>
        <p class="text-uppercase fw-bold mb-2" style="font-size: 0.7rem; letter-spacing: 0.12em; color: var(--primary-blue);">
            <i class="bi bi-shield-check me-1"></i>
            Conformidade NR-1 - Gest√£o de Riscos Psicossociais
        </p>
        <h1 class="mb-1 fw-bold d-flex align-items-center gap-2" style="color: var(--primary-navy); font-size: 2rem; letter-spacing: -0.02em;">
            <div class="d-flex align-items-center justify-content-center rounded" style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%); box-shadow: 0 4px 12px rgba(15, 102, 189, 0.2);">
                <i class="bi bi-graph-up-arrow text-white"></i>
            </div>
            An√°lise de Riscos Psicossociais
        </h1>
        {% if campaign %}
        <p class="mb-0 mt-2" style="font-size: 0.875rem; color: var(--text-secondary);">
            <i class="bi bi-folder-fill text-primary me-1"></i>
            Campanha: <strong style="color: var(--primary-navy);">{{ campaign.nome }}</strong>
            {% if campaign.data_inicio %}
            <span class="mx-2" style="color: var(--border-medium);">|</span>
            <i class="bi bi-calendar3 text-primary me-1"></i>
            In√≠cio: <strong style="color: var(--primary-navy);">{{ campaign.data_inicio | dateformat }}</strong>
            {% endif %}
        </p>
        {% endif %}
    </div>

    {% if campaigns %}
    <div class="d-flex gap-2 align-items-center">
        <div class="d-flex align-items-center gap-2 bg-white border px-3 py-2 rounded shadow-sm">
            <i class="bi bi-calendar3 text-primary"></i>
            <select class="form-select form-select-sm border-0 shadow-none" style="width: 280px;" onchange="location = '?campaign=' + this.value;">
                <option value="">üìä Selecione uma campanha</option>
                {% for c in campaigns %}
                <option value="{{ c.id }}" {% if campaign and c.id == campaign.id %}selected{% endif %}>
                    {{ c.nome }} ({{ c.data_inicio | dateformat }})
                </option>
                {% endfor %}
            </select>
        </div>

        {% if campaign %}
            {# Recursos exclusivos para RH e Superusu√°rio (Lideran√ßa v√™ apenas Dashboard) #}
            {% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}
            <a href="{{ url('analytics:psychosocial_risk_matrix') }}?campaign={{ campaign.id }}" class="btn btn-danger btn-sm">
                <i class="bi bi-shield-exclamation me-1"></i> Matriz de Risco NR-1
            </a>
            <a href="{{ url('surveys:detail', campaign.id) }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-gear me-1"></i> Configurar
            </a>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
</div>

{% if not campaign %}
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-clipboard-data text-muted" style="font-size: 5rem;"></i>
                <h3 class="mt-3">Nenhuma campanha selecionada</h3>
                <p class="text-muted">Selecione uma campanha no menu acima para visualizar os dados{% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %} ou crie uma nova campanha{% endif %}.</p>
                {% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}
                <a href="{{ url('surveys:create') }}" class="btn btn-primary mt-2">
                    <i class="bi bi-plus-circle"></i> Nova Campanha
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}

<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0">
            <i class="bi bi-funnel-fill text-primary"></i> Filtros de An√°lise
        </h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label small text-muted fw-semibold">
                    <i class="bi bi-building"></i> Unidade
                </label>
                <select class="form-select" id="filtro-unidade">
                    <option value="">Todas as Unidades</option>
                    {% for unidade in unidades_disponiveis %}
                    <option value="{{ unidade.id }}" {% if unidade_selecionada and unidade.id|string == unidade_selecionada %}selected{% endif %}>
                        {{ unidade.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label small text-muted fw-semibold">
                    <i class="bi bi-diagram-3"></i> Setor
                </label>
                <select class="form-select" id="filtro-setor">
                    <option value="">Todos os Setores</option>
                    {% for setor in setores_disponiveis %}
                    <option value="{{ setor.id }}" {% if setor_selecionado and setor.id|string == setor_selecionado %}selected{% endif %}>
                        {{ setor.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="{% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}col-md-2{% else %}col-md-4{% endif %} d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" id="btn-limpar-filtros">
                    <i class="bi bi-x-circle"></i> Limpar Filtros
                </button>
            </div>
            {# An√°lises IA - exclusivo para RH e Superusu√°rio #}
            {% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}
            <div class="col-md-2 d-flex align-items-end">
                <a href="{{ url('analytics:sector_analysis_list') }}?campaign={{ campaign.id }}" class="btn btn-primary w-100">
                    <i class="bi bi-robot"></i> An√°lises IA
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Alerta para l√≠deres sem setor selecionado #}
{% if requer_selecao_setor %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning border-0 shadow-sm" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill fs-2 me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">Selecione um setor para visualizar os dados</h5>
                    <p class="mb-0">
                        Para garantir a privacidade e seguran√ßa dos dados, √© necess√°rio selecionar um setor espec√≠fico no filtro acima.
                        Voc√™ tem acesso aos setores permitidos de acordo com suas permiss√µes.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}

<div class="row g-4 mb-4">
    <!-- Card 1: Taxa de Ades√£o -->
    <div class="col-lg-3 col-md-6">
        <div class="card metric-card border-0 shadow-soft h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <p class="text-uppercase text-muted mb-1" style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em;">
                            Taxa de Ades√£o
                        </p>
                    </div>
                    <div class="bg-primary bg-opacity-10 rounded p-2">
                        <i class="bi bi-people-fill text-primary fs-4"></i>
                    </div>
                </div>

                <div class="d-flex align-items-baseline gap-2 mb-2">
                    <h2 class="display-5 mb-0 fw-bold" style="color: var(--primary-navy);">
                        {{ adesao }}%
                    </h2>
                    {% if adesao >= 70 %}
                    <span class="badge bg-success-subtle text-success small">√ìtimo</span>
                    {% elif adesao >= 50 %}
                    <span class="badge bg-warning-subtle text-warning small">Regular</span>
                    {% else %}
                    <span class="badge bg-danger-subtle text-danger small">Baixo</span>
                    {% endif %}
                </div>

                {# N√∫mero de respondentes - apenas para RH e Superusu√°rio #}
                {% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}
                <p class="text-muted small mb-3">
                    <strong>{{ respondidos }}</strong> de <strong>{{ total_convidados }}</strong> convidados
                </p>
                {% else %}
                <p class="text-muted small mb-3">
                    Taxa de participa√ß√£o dos colaboradores
                </p>
                {% endif %}

                <div class="progress" style="height: 6px;">
                    <div class="progress-bar {% if adesao >= 70 %}bg-success{% elif adesao >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                         style="width: {{ adesao }}%; border-radius: 0.5rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card 2: IGRP -->
    <div class="col-lg-3 col-md-6">
        <div class="card metric-card border-0 shadow-soft h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <p class="text-uppercase text-muted mb-1" style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em;">
                        IGRP Index
                    </p>
                    <div class="bg-primary bg-opacity-10 rounded p-2">
                        <i class="bi bi-clipboard-pulse text-primary fs-4"></i>
                    </div>
                </div>

                <div class="d-flex align-items-baseline gap-2 mb-2">
                    <h2 class="display-5 mb-0 fw-bold" style="color: var(--primary-navy);">
                        {{ igrp }}
                    </h2>
                    <span class="badge bg-info-subtle text-info small">√çndice</span>
                </div>

                <p class="text-muted small mb-2">
                    √çndice Geral de Riscos Psicossociais
                </p>
                <span class="badge bg-secondary mt-1" style="font-size: 0.65rem;">Escala 0-4</span>
            </div>
        </div>
    </div>

    <!-- Card 3: Risco Alto/Cr√≠tico -->
    <div class="col-lg-3 col-md-6">
        <div class="card metric-card border-0 shadow-soft h-100" style="border-left: 4px solid var(--risk-critical) !important;">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <p class="text-uppercase text-muted mb-1" style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em;">
                        Risco Alto/Cr√≠tico
                    </p>
                    <div class="bg-danger bg-opacity-10 rounded p-2">
                        <i class="bi bi-exclamation-triangle-fill text-danger fs-4"></i>
                    </div>
                </div>

                <div class="d-flex align-items-baseline gap-2 mb-2">
                    <h2 class="display-5 mb-0 fw-bold text-danger">
                        {{ pct_risco_alto }}%
                    </h2>
                    {% if pct_risco_alto < 15 %}
                    <span class="badge bg-success-subtle text-success small">Controlado</span>
                    {% elif pct_risco_alto > 25 %}
                    <span class="badge bg-danger-subtle text-danger small">Cr√≠tico</span>
                    {% endif %}
                </div>

                <p class="text-muted small mb-2">
                    Colaboradores necessitam aten√ß√£o
                </p>

                {% if pct_risco_alto > 25 %}
                <span class="badge bg-danger small">‚ö†Ô∏è A√ß√£o Imediata</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Card 4: Respostas V√°lidas -->
    <div class="col-lg-3 col-md-6">
        <div class="card metric-card border-0 shadow-soft h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <p class="text-uppercase text-muted mb-1" style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em;">
                        Respostas V√°lidas
                    </p>
                    <div class="bg-success bg-opacity-10 rounded p-2">
                        <i class="bi bi-check-circle-fill text-success fs-4"></i>
                    </div>
                </div>

                <div class="d-flex align-items-baseline gap-2 mb-2">
                    <h2 class="display-5 mb-0 fw-bold" style="color: var(--primary-navy);">
                        {{ respondidos }}
                    </h2>
                    <span class="badge bg-success-subtle text-success small">V√°lidas</span>
                </div>

                <p class="text-muted small mb-2">
                    Question√°rios completos
                </p>
                <span class="badge bg-success small">‚úì Processados</span>
            </div>
        </div>
    </div>
</div>

<!-- Legenda de Classifica√ß√£o de Riscos NR-1 -->
<div class="card border-0 shadow-sm mb-4" style="border-left: 4px solid #17a2b8 !important;">
    <div class="card-body">
        <h6 class="mb-3">
            <i class="bi bi-info-circle-fill text-info"></i> Classifica√ß√£o de Riscos (NR-1)
        </h6>
        <div class="row g-3">
            <div class="col-lg-3 col-md-6">
                <div class="d-flex align-items-center p-2 rounded" style="background-color: rgba(220, 53, 69, 0.1);">
                    <span class="fs-4 me-2">üî¥</span>
                    <div>
                        <div class="badge bg-danger mb-1">CR√çTICO</div>
                        <div class="small text-muted">Risco Intoler√°vel</div>
                        <div class="small fw-semibold">Interven√ß√£o IMEDIATA</div>
                        <div class="small text-muted">Prazo: 30 dias</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="d-flex align-items-center p-2 rounded" style="background-color: rgba(253, 126, 20, 0.1);">
                    <span class="fs-4 me-2">üü†</span>
                    <div>
                        <div class="badge bg-warning text-dark mb-1">IMPORTANTE</div>
                        <div class="small text-muted">Risco Substancial</div>
                        <div class="small fw-semibold">A√ß√£o priorit√°ria</div>
                        <div class="small text-muted">Prazo: 60 dias</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="d-flex align-items-center p-2 rounded" style="background-color: rgba(255, 193, 7, 0.1);">
                    <span class="fs-4 me-2">üü°</span>
                    <div>
                        <div class="badge bg-warning mb-1">MODERADO</div>
                        <div class="small text-muted">Risco Toler√°vel</div>
                        <div class="small fw-semibold">Monitoramento</div>
                        <div class="small text-muted">Prazo: 90 dias</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="d-flex align-items-center p-2 rounded" style="background-color: rgba(40, 167, 69, 0.1);">
                    <span class="fs-4 me-2">üü¢</span>
                    <div>
                        <div class="badge bg-success mb-1">ACEIT√ÅVEL</div>
                        <div class="small text-muted">Risco Trivial</div>
                        <div class="small fw-semibold">Manter controles</div>
                        <div class="small text-muted">Revis√£o anual</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<h3 class="section-title">
    <i class="bi bi-bar-chart-fill text-primary"></i>
    An√°lise por Dimens√µes HSE-IT
</h3>

<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-bar-chart-fill text-primary"></i> √çndice por Dimens√£o</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="chartDimensoes"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> TOP 5 Setores Cr√≠ticos</h6>
            </div>
            <div class="card-body p-0">
                {% if top5_setores %}
                <div class="list-group list-group-flush">
                    {% for item in top5_setores %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <i class="bi bi-building"></i>
                                    <strong>{{ item.setor }}</strong>
                                </div>
                                <span class="badge badge-{{ item.cor }} rounded-pill">
                                    {{ item.nivel_risco }}%
                                </span>
                            </div>

                            {% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}
                                {% if item.setor_id %}
                                    <a href="{{ url('surveys:detail', campaign.id) }}"
                                    class="btn btn-sm btn-outline-primary w-100">
                                        <i class="bi bi-robot"></i> Ver An√°lise IA
                                    </a>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-secondary w-100" disabled>
                                        <i class="bi bi-exclamation-circle"></i> Setor indispon√≠vel
                                    </button>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endfor %}
                </div>
                {% else %}
                <div class="p-3 text-center text-muted">
                    <i class="bi bi-check-circle"></i> Nenhum setor cr√≠tico identificado
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h6 class="mb-0"><i class="bi bi-pie-chart-fill text-primary"></i> Distribui√ß√£o de Riscos</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="chartDistribuicao"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<h3 class="section-title">
    <i class="bi bi-graph-up text-primary"></i>
    An√°lises Detalhadas
</h3>

<div class="row g-4 mb-4">
    {# An√°lise por G√™nero - apenas para RH e Superusu√°rio #}
    {% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-gender-ambiguous text-primary"></i> An√°lise por G√™nero</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="chartGenero"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="{% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}col-lg-6{% else %}col-12{% endif %}">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-calendar-range text-primary"></i> An√°lise por Faixa Et√°ria</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="chartFaixaEtaria"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-soft">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0 fw-bold" style="color: var(--primary-navy);">
                    <i class="bi bi-ui-checks text-primary me-2"></i>
                    Matriz de Risco por Setor e Dimens√£o
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    <i class="bi bi-info-circle text-primary me-1"></i> Cores representam o n√≠vel de risco:
                    <span class="badge badge-verde ms-2">Baixo</span>
                    <span class="badge badge-amarelo ms-1">Moderado</span>
                    <span class="badge badge-laranja ms-1">Alto</span>
                    <span class="badge badge-vermelho ms-1">Cr√≠tico</span>
                </p>
                <div class="table-responsive">
                    <table class="table table-sm mb-0 align-middle">
                        <thead style="background-color: #f8fafc;">
                            <tr>
                                <th class="text-uppercase fw-semibold" style="font-size: 0.7rem; letter-spacing: 0.05em; color: var(--text-secondary);">
                                    Setor
                                </th>
                                {% for dim_label in dimensoes_labels %}
                                <th class="text-center text-uppercase fw-semibold" style="font-size: 0.7rem; letter-spacing: 0.05em; color: var(--text-secondary);">
                                    {{ dim_label }}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for setor_data in heatmap_data %}
                            <tr>
                                <td class="fw-bold" style="color: var(--primary-navy);">
                                    <i class="bi bi-building text-muted me-2"></i>
                                    {{ setor_data.setor }}
                                </td>
                                {% for score in setor_data.scores %}
                                <td class="text-center p-2">
                                    <div class="heatmap-cell d-flex align-items-center justify-content-center p-2 fw-bold text-white"
                                         style="
                                            background-color: {% if score >= 3.5 %}#28a745{% elif score >= 2.5 %}#ffc107{% elif score >= 1.5 %}#fd7e14{% else %}#dc3545{% endif %};
                                            min-height: 48px;
                                            border-radius: 0.375rem;
                                            font-size: 0.875rem;
                                         ">
                                        {{ score }}
                                    </div>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<h3 class="section-title">
    <i class="bi bi-people-fill text-primary"></i>
    An√°lise Demogr√°fica Detalhada
</h3>

<div class="row g-4 mb-4">
    {# Score por G√™nero - apenas para RH e Superusu√°rio #}
    {% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-bar-chart-line text-primary"></i> Score M√©dio por Dimens√£o - G√™nero</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="chartScoresGenero"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="{% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}col-lg-6{% else %}col-12{% endif %}">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-graph-up text-primary"></i> Score M√©dio por Dimens√£o - Faixa Et√°ria</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="chartScoresFaixaEtaria"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{# TOP 3 Grupos Demogr√°ficos - apenas para RH e Superusu√°rio #}
{% if request.user.is_superuser or (request.user.profile and request.user.profile.role == 'rh') %}
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-diamond-fill"></i> TOP 3 Grupos Demogr√°ficos em Risco Cr√≠tico</h5>
            </div>
            <div class="card-body">
                {% if top_grupos_criticos %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th><i class="bi bi-trophy-fill"></i> Ranking</th>
                                <th><i class="bi bi-people-fill"></i> Grupo Demogr√°fico</th>
                                <th class="text-center"><i class="bi bi-person-badge"></i> N¬∞ Respostas</th>
                                <th class="text-center"><i class="bi bi-exclamation-triangle-fill"></i> N√≠vel de Risco</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in top_grupos_criticos %}
                            <tr>
                                <td class="fw-bold">
                                    {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% else %}ü•â{% endif %}
                                    #{{ loop.index }}
                                </td>
                                <td><strong>{{ item.grupo }}</strong></td>
                                <td class="text-center">{{ item.total_respostas }}</td>
                                <td class="text-center">
                                    <span class="badge badge-{{ item.cor }} fs-6">{{ item.nivel_risco }}%</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle" style="font-size: 3rem;"></i>
                    <p class="mt-2 mb-0">Nenhum grupo demogr√°fico em risco cr√≠tico identificado</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row g-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clipboard-check text-primary"></i> A√ß√µes Recomendadas</h5>
                <a href="{{ url('actions:plano_acao_list', campaign_id=campaign.id) }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus"></i> Criar Plano de A√ß√£o
                </a>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="bi bi-lightbulb-fill"></i> <strong>Recomenda√ß√µes baseadas nos resultados:</strong>
                </div>
                <ul class="list-group list-group-flush">
                    {% if pct_risco_alto > 25 %}
                    <li class="list-group-item">
                        <i class="bi bi-exclamation-circle text-danger"></i>
                        <strong>Prioridade Alta:</strong> Mais de 25% dos colaboradores em risco cr√≠tico. Implemente planos de a√ß√£o imediatos.
                    </li>
                    {% endif %}
                    {% if adesao < 70 %}
                    <li class="list-group-item">
                        <i class="bi bi-info-circle text-warning"></i>
                        <strong>Ades√£o Baixa:</strong> Reforce a comunica√ß√£o e incentive a participa√ß√£o na pesquisa.
                    </li>
                    {% endif %}
                    <li class="list-group-item">
                        <i class="bi bi-check-circle text-success"></i>
                        Revise os planos de a√ß√£o e acompanhe sua implementa√ß√£o regularmente.
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% endif %}{# Fim do bloco else de requer_selecao_setor #}

{% endif %}{# Fim do bloco if campaign #}
{% endblock %}

{% block scripts %}
{% if campaign %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// JavaScript para filtros interativos
document.addEventListener('DOMContentLoaded', function() {
    const filtroUnidade = document.getElementById('filtro-unidade');
    const filtroSetor = document.getElementById('filtro-setor');
    const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
    const campaignId = '{{ campaign.id }}';

    // Fun√ß√£o para construir URL com filtros
    function buildFilterUrl() {
        const params = new URLSearchParams();
        params.append('campaign', campaignId);

        const unidade = filtroUnidade.value;
        const setor = filtroSetor.value;

        if (unidade) {
            params.append('unidade', unidade);
        }
        if (setor) {
            params.append('setor', setor);
        }

        return '?' + params.toString();
    }

    // Event listener para mudan√ßa de unidade
    filtroUnidade.addEventListener('change', function() {
        window.location.href = buildFilterUrl();
    });

    // Event listener para mudan√ßa de setor
    filtroSetor.addEventListener('change', function() {
        window.location.href = buildFilterUrl();
    });

    // Event listener para limpar filtros
    btnLimparFiltros.addEventListener('click', function() {
        window.location.href = '?campaign=' + campaignId;
    });
});
</script>
<script>
// Gr√°fico de Dimens√µes
const ctxDimensoes = document.getElementById('chartDimensoes').getContext('2d');
new Chart(ctxDimensoes, {
    type: 'bar',
    data: {
        labels: {{ dimensoes_labels | tojson | safe }},
        datasets: [{
            label: 'Score M√©dio',
            data: {{ dimensoes_scores | tojson | safe }},
            backgroundColor: {{ dimensoes_cores | tojson | safe }},
            borderColor: {{ dimensoes_cores | tojson | safe }},
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Score: ' + context.parsed.x.toFixed(2) + ' (0-4)';
                    }
                }
            }
        },
        scales: {
            x: {
                min: 0,
                max: 4,
                title: { display: true, text: 'Score (0-4)' }
            }
        }
    }
});

// Gr√°fico de Distribui√ß√£o
const ctxDist = document.getElementById('chartDistribuicao').getContext('2d');
new Chart(ctxDist, {
    type: 'doughnut',
    data: {
        labels: ['Aceit√°vel', 'Moderado', 'Importante', 'Cr√≠tico'],
        datasets: [{
            data: {{ distribuicao_values | tojson | safe }},
            backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

// Gr√°fico por G√™nero
const ctxGenero = document.getElementById('chartGenero').getContext('2d');
new Chart(ctxGenero, {
    type: 'bar',
    data: {
        labels: {{ genero_labels | tojson | safe }},
        datasets: [{
            label: 'N√∫mero de Respostas',
            data: {{ genero_values | tojson | safe }},
            backgroundColor: ['#4e73df', '#e74a3b', '#36b9cc', '#858796']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        }
    }
});

// Gr√°fico por Faixa Et√°ria
const ctxFaixa = document.getElementById('chartFaixaEtaria').getContext('2d');
new Chart(ctxFaixa, {
    type: 'line',
    data: {
        labels: {{ faixa_etaria_labels | tojson | safe }},
        datasets: [{
            label: 'N√∫mero de Respostas',
            data: {{ faixa_etaria_values | tojson | safe }},
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        }
    }
});

// Gr√°fico de Scores por G√™nero (Barras Agrupadas)
const ctxScoresGenero = document.getElementById('chartScoresGenero').getContext('2d');
const scoresGeneroData = {{ scores_por_genero | tojson | safe }};
const generos = Object.keys(scoresGeneroData);
const dimensoesLabels = {{ dimensoes_labels | tojson | safe }};

const datasetsGenero = generos.map((genero, index) => {
    const colors = ['#4e73df', '#e74a3b', '#36b9cc', '#858796'];
    const scoresArray = dimensoesLabels.map(dim => scoresGeneroData[genero][dim] || 0);

    return {
        label: genero,
        data: scoresArray,
        backgroundColor: colors[index % colors.length],
        borderColor: colors[index % colors.length],
        borderWidth: 2
    };
});

new Chart(ctxScoresGenero, {
    type: 'bar',
    data: {
        labels: dimensoesLabels,
        datasets: datasetsGenero
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: { font: { size: 12 } }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' (0-4)';
                    }
                }
            }
        },
        scales: {
            y: {
                min: 0,
                max: 4,
                title: { display: true, text: 'Score M√©dio (0-4)' }
            },
            x: {
                title: { display: true, text: 'Dimens√µes HSE-IT' }
            }
        }
    }
});

// Gr√°fico de Scores por Faixa Et√°ria (Linhas)
const ctxScoresFaixa = document.getElementById('chartScoresFaixaEtaria').getContext('2d');
const scoresFaixaData = {{ scores_por_faixa_etaria | tojson | safe }};
const faixas = Object.keys(scoresFaixaData).sort((a, b) => {
    const ordem = ['18-24', '25-34', '35-49', '50-59', '60+'];
    return ordem.indexOf(a) - ordem.indexOf(b);
});

const datasetsFaixa = dimensoesLabels.map((dimensao, index) => {
    const colors = [
        '#dc3545', '#fd7e14', '#ffc107', '#28a745',
        '#20c997', '#17a2b8', '#007bff', '#6610f2', '#6f42c1'
    ];
    const scoresArray = faixas.map(faixa => scoresFaixaData[faixa][dimensao] || 0);

    return {
        label: dimensao,
        data: scoresArray,
        borderColor: colors[index % colors.length],
        backgroundColor: colors[index % colors.length],
        borderWidth: 2,
        tension: 0.4,
        fill: false
    };
});

new Chart(ctxScoresFaixa, {
    type: 'line',
    data: {
        labels: faixas,
        datasets: datasetsFaixa
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: { font: { size: 10 } }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' (0-4)';
                    }
                }
            }
        },
        scales: {
            y: {
                min: 0,
                max: 4,
                title: { display: true, text: 'Score M√©dio (0-4)' }
            },
            x: {
                title: { display: true, text: 'Faixa Et√°ria' }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
