{% extends 'base.html' %}

{% block title %}Dashboard de Riscos Psicossociais{% endblock %}

{% block extra_head %}
<style>
    .metric-card {
        border-left: 4px solid;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .metric-card.success { border-color: #28a745; }
    .metric-card.warning { border-color: #ffc107; }
    .metric-card.danger { border-color: #dc3545; }
    .metric-card.info { border-color: #17a2b8; }

    .chart-container {
        position: relative;
        height: 400px;
    }

    .badge-vermelho { background-color: #dc3545; }
    .badge-laranja { background-color: #fd7e14; }
    .badge-amarelo { background-color: #ffc107; color: #000; }
    .badge-verde { background-color: #28a745; }

    .section-title {
        border-left: 4px solid {{ branding.cor_primaria }};
        padding-left: 15px;
        margin: 30px 0 20px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-1">
            <i class="bi bi-graph-up-arrow text-primary"></i> Dashboard de Riscos Psicossociais
        </h1>
        {% if campaign %}
        <p class="text-muted mb-0">An√°lise da campanha: <strong>{{ campaign.nome }}</strong></p>
        {% endif %}
    </div>
    {% if campaigns %}
    <div class="d-flex gap-2">
        <select class="form-select" style="width: 300px;" onchange="location = '?campaign=' + this.value;">
            <option value="">üìä Selecione uma campanha</option>
            {% for c in campaigns %}
            <option value="{{ c.id }}" {% if campaign and c.id == campaign.id %}selected{% endif %}>
                {{ c.nome }} ({{ c.data_inicio | dateformat }})
            </option>
            {% endfor %}
        </select>
        {% if campaign %}
        <a href="{{ url('surveys:detail', campaign.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-gear"></i> Configurar
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

{% if not campaign %}
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-clipboard-data text-muted" style="font-size: 5rem;"></i>
                <h3 class="mt-3">Nenhuma campanha selecionada</h3>
                <p class="text-muted">Selecione uma campanha no menu acima para visualizar os dados ou crie uma nova campanha.</p>
                <a href="{{ url('surveys:create') }}" class="btn btn-primary mt-2">
                    <i class="bi bi-plus-circle"></i> Nova Campanha
                </a>
            </div>
        </div>
    </div>
</div>
{% else %}

<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card metric-card {% if adesao >= 70 %}success{% elif adesao >= 50 %}warning{% else %}danger{% endif %} border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="fs-6 text-muted fw-semibold">Taxa de Ades√£o</div>
                    <i class="bi bi-people-fill {% if adesao >= 70 %}text-success{% elif adesao >= 50 %}text-warning{% else %}text-danger{% endif %}" style="font-size: 1.5rem;"></i>
                </div>
                <h2 class="display-5 mb-1 fw-bold {% if adesao >= 70 %}text-success{% elif adesao >= 50 %}text-warning{% else %}text-danger{% endif %}">
                    {{ adesao }}%
                </h2>
                <p class="text-muted mb-0 small">
                    <strong>{{ respondidos }}</strong> de <strong>{{ total_convidados }}</strong> convidados
                </p>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar {% if adesao >= 70 %}bg-success{% elif adesao >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                         style="width: {{ adesao }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="card metric-card info border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="fs-6 text-muted fw-semibold">IGRP</div>
                    <i class="bi bi-clipboard-pulse text-info" style="font-size: 1.5rem;"></i>
                </div>
                <h2 class="display-5 mb-1 fw-bold text-info">{{ igrp }}</h2>
                <p class="text-muted mb-0 small">√çndice Geral de Riscos Psicossociais</p>
                <div class="mt-2">
                    <span class="badge bg-secondary">Escala 0-4</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="card metric-card danger border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="fs-6 text-muted fw-semibold">Risco Alto/Cr√≠tico</div>
                    <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 1.5rem;"></i>
                </div>
                <h2 class="display-5 mb-1 fw-bold text-danger">{{ pct_risco_alto }}%</h2>
                <p class="text-muted mb-0 small">Colaboradores necessitam aten√ß√£o</p>
                {% if pct_risco_alto > 25 %}
                <div class="mt-2">
                    <span class="badge bg-danger">‚ö†Ô∏è A√ß√£o Imediata</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="card metric-card success border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="fs-6 text-muted fw-semibold">Respostas V√°lidas</div>
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                </div>
                <h2 class="display-5 mb-1 fw-bold">{{ respondidos }}</h2>
                <p class="text-muted mb-0 small">Question√°rios completos</p>
                <div class="mt-2">
                    <span class="badge bg-success">‚úì Processados</span>
                </div>
            </div>
        </div>
    </div>
</div>

<h3 class="section-title">üìä An√°lise por Dimens√µes HSE-IT</h3>

<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-bar-chart-fill text-primary"></i> √çndice por Dimens√£o</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="chartDimensoes"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> TOP 5 Setores Cr√≠ticos</h6>
            </div>
            <div class="card-body p-0">
                {% if top5_setores %}
                <div class="list-group list-group-flush">
                    {% for item in top5_setores %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-building"></i>
                            <strong>{{ item.setor }}</strong>
                        </div>
                        <span class="badge badge-{{ item.cor }} rounded-pill">{{ item.nivel_risco }}%</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-3 text-center text-muted">
                    <i class="bi bi-check-circle"></i> Nenhum setor cr√≠tico identificado
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h6 class="mb-0"><i class="bi bi-pie-chart-fill text-primary"></i> Distribui√ß√£o de Riscos</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="chartDistribuicao"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<h3 class="section-title">üìà An√°lises Detalhadas</h3>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-gender-ambiguous text-primary"></i> An√°lise por G√™nero</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="chartGenero"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-calendar-range text-primary"></i> An√°lise por Faixa Et√°ria</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="chartFaixaEtaria"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-ui-checks text-primary"></i> Matriz de Risco por Setor e Dimens√£o</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    <i class="bi bi-info-circle"></i> Cores representam o n√≠vel de risco:
                    <span class="badge badge-verde">Baixo</span>
                    <span class="badge badge-amarelo">Moderado</span>
                    <span class="badge badge-laranja">Alto</span>
                    <span class="badge badge-vermelho">Cr√≠tico</span>
                </p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center">
                        <thead>
                            <tr class="table-light">
                                <th>Setor</th>
                                {% for dim_label in dimensoes_labels %}
                                <th class="small">{{ dim_label }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for setor_data in heatmap_data %}
                            <tr>
                                <td class="text-start fw-semibold">{{ setor_data.setor }}</td>
                                {% for score in setor_data.scores %}
                                <td style="background-color: {% if score >= 3.5 %}#d4edda{% elif score >= 2.5 %}#fff3cd{% elif score >= 1.5 %}#ffe5d0{% else %}#f8d7da{% endif %};">
                                    {{ score }}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clipboard-check text-primary"></i> A√ß√µes Recomendadas</h5>
                <a href="{{ url('actions:planos', campaign_id=campaign.id) }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus"></i> Criar Plano de A√ß√£o
                </a>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="bi bi-lightbulb-fill"></i> <strong>Recomenda√ß√µes baseadas nos resultados:</strong>
                </div>
                <ul class="list-group list-group-flush">
                    {% if pct_risco_alto > 25 %}
                    <li class="list-group-item">
                        <i class="bi bi-exclamation-circle text-danger"></i>
                        <strong>Prioridade Alta:</strong> Mais de 25% dos colaboradores em risco cr√≠tico. Implemente planos de a√ß√£o imediatos.
                    </li>
                    {% endif %}
                    {% if adesao < 70 %}
                    <li class="list-group-item">
                        <i class="bi bi-info-circle text-warning"></i>
                        <strong>Ades√£o Baixa:</strong> Reforce a comunica√ß√£o e incentive a participa√ß√£o na pesquisa.
                    </li>
                    {% endif %}
                    <li class="list-group-item">
                        <i class="bi bi-check-circle text-success"></i>
                        Revise o <a href="{{ url('actions:checklist', campaign_id=campaign.id) }}">checklist de conformidade NR-1</a> para garantir todas as etapas.
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
{% if campaign %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Gr√°fico de Dimens√µes
const ctxDimensoes = document.getElementById('chartDimensoes').getContext('2d');
new Chart(ctxDimensoes, {
    type: 'bar',
    data: {
        labels: {{ dimensoes_labels | tojson | safe }},
        datasets: [{
            label: 'Score M√©dio',
            data: {{ dimensoes_scores | tojson | safe }},
            backgroundColor: {{ dimensoes_cores | tojson | safe }},
            borderColor: {{ dimensoes_cores | tojson | safe }},
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Score: ' + context.parsed.x.toFixed(2) + ' (0-4)';
                    }
                }
            }
        },
        scales: {
            x: {
                min: 0,
                max: 4,
                title: { display: true, text: 'Score (0-4)' }
            }
        }
    }
});

// Gr√°fico de Distribui√ß√£o
const ctxDist = document.getElementById('chartDistribuicao').getContext('2d');
new Chart(ctxDist, {
    type: 'doughnut',
    data: {
        labels: ['Aceit√°vel', 'Moderado', 'Importante', 'Cr√≠tico'],
        datasets: [{
            data: {{ distribuicao_values | tojson | safe }},
            backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

// Gr√°fico por G√™nero
const ctxGenero = document.getElementById('chartGenero').getContext('2d');
new Chart(ctxGenero, {
    type: 'bar',
    data: {
        labels: {{ genero_labels | tojson | safe }},
        datasets: [{
            label: 'N√∫mero de Respostas',
            data: {{ genero_values | tojson | safe }},
            backgroundColor: ['#4e73df', '#e74a3b', '#36b9cc', '#858796']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        }
    }
});

// Gr√°fico por Faixa Et√°ria
const ctxFaixa = document.getElementById('chartFaixaEtaria').getContext('2d');
new Chart(ctxFaixa, {
    type: 'line',
    data: {
        labels: {{ faixa_etaria_labels | tojson | safe }},
        datasets: [{
            label: 'N√∫mero de Respostas',
            data: {{ faixa_etaria_values | tojson | safe }},
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        }
    }
});
</script>
{% endif %}
{% endblock %}
